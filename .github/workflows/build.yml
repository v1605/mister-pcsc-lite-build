name: build-pcsc-lite

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - uses: actions/checkout@v4

      - name: Enable armhf architecture
        run: |
          sudo dpkg --add-architecture armhf
          sudo sed -i '/security.ubuntu.com/d' /etc/apt/sources.list
          echo "deb http://ports.ubuntu.com/ubuntu-ports jammy main universe multiverse" | sudo tee /etc/apt/sources.list.d/ports.list
          echo "deb http://ports.ubuntu.com/ubuntu-ports jammy-updates main universe multiverse" | sudo tee -a /etc/apt/sources.list.d/ports.list
          echo "deb http://ports.ubuntu.com/ubuntu-ports jammy-security main universe multiverse" | sudo tee -a /etc/apt/sources.list.d/ports.list
          sudo apt update

      - name: Install build dependencies
        run: |
          sudo apt install -y \
            gcc-arm-linux-gnueabihf \
            g++-arm-linux-gnueabihf \
            pkg-config \
            meson \
            ninja-build \
            libusb-1.0-0-dev:armhf \
            libudev-dev:armhf \
            libsystemd-dev:armhf \
            libssl-dev:armhf

      - name: Clone pcsc-lite
        run: |
          git clone https://github.com/LudovicRousseau/PCSC.git pcsc-lite

      - name: Configure build
        run: |
          cat > meson_cross.txt <<EOF
          [binaries]
          c = 'arm-linux-gnueabihf-gcc'
          cpp = 'arm-linux-gnueabihf-g++'
          ar = 'arm-linux-gnueabihf-ar'
          strip = 'arm-linux-gnueabihf-strip'
          pkgconfig = 'pkg-config'

          [host_machine]
          system = 'linux'
          cpu_family = 'arm'
          cpu = 'armv7'
          endian = 'little'
          EOF

          meson setup build pcsc-lite \
            --cross-file meson_cross.txt \
            --prefix=/usr \
            -Dlibusb=true \
            -Dudev=true \
            -Dsystemd=false \
            -Dpolkit=false \
            -Dserial=false \
            -Dusb=true

      - name: Compile
        run: |
          ninja -C build

      - name: Package binary
        run: |
          mkdir -p out
          cp build/src/pcscd out/
          arm-linux-gnueabihf-strip out/pcscd
          tar czf pcsc-lite-mister-armhf.tar.gz -C out pcscd

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: pcsc-lite-mister-armhf
          path: pcsc-lite-mister-armhf.tar.gz
