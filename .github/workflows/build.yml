name: Build pcsc-lite for MiSTer

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout build repo
      uses: actions/checkout@v4

    - name: Checkout pcsc-lite
      uses: actions/checkout@v4
      with:
        repository: LudovicRousseau/PCSC
        path: pcsc-lite
        ref: master   

    - name: Configure APT for armhf
      run: |
        sudo sed -i 's|^deb http://archive.ubuntu.com/ubuntu|deb [arch=amd64] http://archive.ubuntu.com/ubuntu|' /etc/apt/sources.list
        sudo sed -i 's|^deb http://security.ubuntu.com/ubuntu|deb [arch=amd64] http://security.ubuntu.com/ubuntu|' /etc/apt/sources.list

        sudo tee /etc/apt/sources.list.d/armhf.list > /dev/null << 'EOF'
        deb [arch=armhf] http://ports.ubuntu.com/ubuntu-ports jammy main restricted universe multiverse
        deb [arch=armhf] http://ports.ubuntu.com/ubuntu-ports jammy-updates main restricted universe multiverse
        deb [arch=armhf] http://ports.ubuntu.com/ubuntu-ports jammy-security main restricted universe multiverse
        EOF

        sudo dpkg --add-architecture armhf
        sudo apt update

    - name: Install build dependencies
      run: |
        sudo apt install -y \
          meson \
          ninja-build \
          pkg-config \
          gcc-arm-linux-gnueabihf \
          g++-arm-linux-gnueabihf \
          libusb-1.0-0-dev:armhf \
          libudev-dev:armhf

    - name: Build pcsc-lite
      run: |
        chmod +x build.sh
        ./build.sh

    - name: Package artifact
      run: |
        tar -C output -czf pcsc-lite-mister.tar.gz .

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: pcsc-lite-mister
        path: pcsc-lite-mister.tar.gz

    - name: Create GitHub Release
      if: github.ref == 'refs/heads/main'
      uses: softprops/action-gh-release@v2
      with:
        files: pcsc-lite-mister.tar.gz
